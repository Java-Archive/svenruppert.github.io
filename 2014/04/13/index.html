<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="shortcut icon" href="../../assets/ico/favicon.ico">

    <title>Blog-Vorlage für Bootstrap</title>

    <!-- Bootstrap-CSS -->
    <link href="http://svenruppert.github.io/site/css/bootstrap.min.css" rel="stylesheet">

    <!-- Besondere Stile für diese Vorlage -->
    <link href="http://svenruppert.github.io/site/css/blog.css" rel="stylesheet">

    <!-- Nur für Testzwecke. Kopiere diese Zeile nicht in echte Projekte! -->
    <!--[if lt IE 9]>
    <script src="http://svenruppert.github.io/site/js/ie8-responsive-file-warning.js"></script><![endif]-->

    <!-- Unterstützung für Media Queries und HTML5-Elemente im Internet Explorer über HTML5 shim und Respond.js -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->


    <!-- Include required JS files -->
    <script type="text/javascript" src="http://svenruppert.github.io/site/syntax/shCore.js"></script>
    <script type="text/javascript" src="http://svenruppert.github.io/site/syntax/shBrushJava.js"></script>
    <script type="text/javascript" src="http://svenruppert.github.io/site/syntax/shBrushJavaFX.js"></script>
    <script type="text/javascript" src="http://svenruppert.github.io/site/syntax/shBrushSql.js"></script>
    <script type="text/javascript" src="http://svenruppert.github.io/site/syntax/shBrushJScript.js"></script>

    <!-- Include *at least* the core style and default theme -->
    <link href="http://svenruppert.github.io/site/syntax/shCore.css" rel="stylesheet" type="text/css" />
    <link href="http://svenruppert.github.io/site/syntax/shThemeDefault.css" rel="stylesheet" type="text/css" />


    <!-- Google Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-35462441-1', 'auto');
    ga('send', 'pageview');

    </script>
    <!-- End Google Analytics -->
</head>

<body>

<div class="blog-masthead">
    <div class="container">
        <nav class="blog-nav">
            <a class="blog-nav-item active" href="#">Start</a>
            <a class="blog-nav-item" href="#">Neue Funktionen</a>
            <a class="blog-nav-item" href="#">Presse</a>
            <a class="blog-nav-item" href="#">Neue Mitarbeiter</a>
            <a class="blog-nav-item" href="#">Über</a>
        </nav>
    </div>
</div>

<div class="container">

    <div class="blog-header">
        <h1 class="blog-title">Das Bootstrap Blog</h1>
        <p class="lead blog-description">Die offizielle Beispiel-Vorlage für die Erstellung von Blogs mit Bootstrap.</p>
    </div>

    <div class="row">

        <div class="col-sm-8 blog-main">
<div class="blog-post">
<h2 class="blog-post-title"><a href=/2014/04/13/java8-completablefuture-for-javafx-and.html>Java8 CompletableFuture for JavaFX and CDI Part II</a></h2>
<p class="blog-post-meta">2014-04-13 from <a href="/team/sven-ruppert/">Sven Ruppert</a></p>
The last part was describing how you could reach the goal to make the order of some dependent method calls independent.
Now we will see, how we could use this for the combination of CDI and JavaFX.
<br/>
If you want to have CDI managed Controllers inside your JavaFX application you have to deal with the two life cycles.
The init from CDI and the init from JavaFX. If you are combining both technologies, you will have the problem that
the order of the livecycle steps are not always in the same order. Depending from the technology that will start,
the order of the init methods will change. For CDI it is the method with the annotation Postconstruct and for JavaFX the method initialize.
<br/>
Well, lets see what you could do..
<br/>
For this example I will start with the FXMLoader. Check the Method setControllerFactory.
You will see, that after the creation of the Controller instance the method initInstance() will be called.
<br />
<pre class="brush: java">
@Singleton
public class FXMLLoaderSingleton {

    private @Inject @CDILogger Logger logger;
    private @Inject Instance&lt;CDIJavaFxBaseController&gt; instance;

    private final ClassLoader cachingClassLoader = new FXClassLoader(FXMLLoader.getDefaultClassLoader());
    private final Map&lt;Class, FXMLLoader&gt; class2LoaderMap = new HashMap&lt;Class, FXMLLoader&gt;();

    public FXMLLoader getFXMLLoader(Class clazz) {
        final Map&lt;Class, FXMLLoader&gt; loaderMap = class2LoaderMap;
        final String name = clazz.getName();
        if (loaderMap.containsKey(clazz)) {
            if (logger.isDebugEnabled()) {
                logger.debug(&quot;fx loader fuer diese klasse schon in der map &quot; + name);
            }
        } else {
            final String fxmlFileName = clazz.getSimpleName() + &quot;.fxml&quot;;
            if (logger.isDebugEnabled()) {
                logger.debug(&quot;fxmlFileName -&gt; &quot; + fxmlFileName);
            }
            final URL resource = clazz.getResource(fxmlFileName);
//            FXMLLoader loader = new CDIFXMLLoader(resource);
            FXMLLoader loader = new FXMLLoader(resource);
            loader.setClassLoader(cachingClassLoader);
            loader.setControllerFactory(new Callback&lt;Class&lt;?&gt;, Object&gt;() {
                @Override
                public Object call(Class&lt;?&gt; param) {
                    final Class&lt;JavaFXBaseController&gt; p = (Class&lt;JavaFXBaseController&gt;) param;
                    final JavaFXBaseController controller = instance.select(p).get();
                    <b>controller.initInstance(); //trigger async call</b>
                    return controller;
                }
            });
            try {
                final Class&lt;?&gt; aClass = Class.forName(clazz.getName() + &quot;Controller&quot;);
                final CDIJavaFxBaseController call = (CDIJavaFxBaseController) loader.getControllerFactory().call(aClass);
                loader.setController(call);
            } catch (ClassNotFoundException e) {
                logger.error(e);
            }
            loaderMap.put(clazz, loader);
        }
        return loaderMap.get(clazz);
    }

    private FXMLLoaderSingleton() {
    }
}
</pre>
<br/>
The method <b>initInstance()</b> will trigger the init-process. Inside the method the task will be called async.
The task itself will wait until the CDi and JavaFX init will be ready. After this the method  initBusinessLogic will be called.
This means, thet the developer only will have to implement the method <b>initBusinessLogic</b> and he will be sure that all init stuff is done.
<br/>
Happy coding ;-)

<br />
<pre class="brush: java">
public abstract class JavaFXBaseController implements CDIJavaFxBaseController {

    public static final String DONE = "done";

    private boolean mockModusActive = false;
    public boolean isMockModusActive() {
        return mockModusActive;
    }
    public void setMockModusActive(boolean mockModusActive) {
        this.mockModusActive = mockModusActive;
    }

    public abstract void cleanUp();

    public abstract void setI18n();

    private @Inject @CDILogger Logger logger;

    private Boolean initCompleteCDI = false;
    private Boolean initCompleteFX = false;

    public CompletableFuture&lt;String&gt; supplyAsync;

    @Override
    public final void initInstance(){
       final CachedThreadPoolSingleton instance = CachedThreadPoolSingleton.getInstance();
       supplyAsync = CompletableFuture.supplyAsync(task, instance.cachedThreadPool);
       if (logger.isDebugEnabled()) supplyAsync.thenAccept(logger::debug);  //logger
    }

    public final Supplier&lt;String&gt; task = ()-> {
        //        Warten bis alle true
        while(! (initCompleteCDI && initCompleteFX) ){
        try {
        //evtl loggen
        if (logger.isDebugEnabled()) {
        logger.debug("initCompleteCDI = " + initCompleteCDI);
        logger.debug("initCompleteFX = " + initCompleteFX);
        logger.debug("getClass().getName() = " + getClass().getName());
        }
        TimeUnit.MILLISECONDS.sleep(1);
        } catch (InterruptedException e) {
        e.printStackTrace();
        return e.toString();
        }
        }

        if (logger.isInfoEnabled()) {
        logger.info("initBusinessLogic() => called now");
        }
        final boolean fxApplicationThread = Platform.isFxApplicationThread();
        if ( ! fxApplicationThread){
        Platform.runLater(this::initBusinessLogic);
        } else {
        initBusinessLogic();
        }


        if (logger.isInfoEnabled()) {
        logger.info("initBusinessLogic() => done now");
        }
        return DONE;
        };

        @PostConstruct
        public final void postconstruct(){
        if (logger.isDebugEnabled()) {
        logger.debug("PostConstruct mockModusActive == " + mockModusActive);
        }
        cdiPostConstruct();
        initCompleteCDI = true;
        if (logger.isDebugEnabled()) {
        logger.debug("postconstruct ready " + getClass().getName());
        }
        }

        public abstract void cdiPostConstruct();

        @Override
        public final void initialize(URL url, ResourceBundle resourceBundle) {
        if (logger.isDebugEnabled()) {
        logger.debug("initialize mockModusActive== " + mockModusActive);
        }
        initializeFX(url, resourceBundle);
        initCompleteFX = true;
        if (logger.isDebugEnabled()) {
        logger.debug("initialize ready " + getClass().getName());
        }
        }


        protected abstract void initializeFX(URL url, ResourceBundle resourceBundle);
        /**
        * wird nach der init von CDI und JavaFX aufgerufen,
        * egal in welcher Reihenfolge die init durchlaufen wird.
        *
        * ein blockierender method call
        *
        */
        public abstract void initBusinessLogic();
        }
</pre>






</div>
            <ul class="pager">
                <li><a href="#">Vorherige</a></li>
                <li><a href="#">Nächste</a></li>
            </ul>

        </div><!-- /.blog-main -->

        <div class="col-sm-3 col-sm-offset-1 blog-sidebar">
            <div class="sidebar-module sidebar-module-inset">
                <h4>Über</h4>
                <p>Etiam porta <em>sem malesuada magna</em> mollis euismod. Cras mattis consectetur purus sit amet fermentum. Aenean lacinia bibendum nulla sed consectetur.</p>
            </div>
            <div class="sidebar-module">
                <h4>Archives</h4>
                <ol class="list-unstyled">
<li><a href="/2014/06">2014-06</a></li>
<li><a href="/2014/04">2014-04</a></li>
                </ol>
            </div>
            <div class="sidebar-module">
                <h4>Woanders</h4>
                <ol class="list-unstyled">
                    <li><a href="#">GitHub</a></li>
                    <li><a href="#">Twitter</a></li>
                    <li><a href="#">Facebook</a></li>
                </ol>
            </div>
        </div><!-- /.blog-sidebar -->

    </div><!-- /.row -->

</div><!-- /.container -->

<div class="blog-footer">
    <p>Blog-Vorlage, gemacht für <a href="http://getbootstrap.com">Bootstrap</a> von <a href="https://twitter.com/mdo">@mdo</a>.</p>
    <p>
        <a href="#">Zurück nach oben</a>
    </p>
</div>


<!-- Bootstrap-JavaScript
================================================== -->
<!-- Am Ende des Dokuments platziert, damit Seiten schneller laden -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="http://svenruppert.github.io/site/js/bootstrap.min.js"></script>
<script src="http://svenruppert.github.io/site/js/docs.min.js"></script>
<!-- Finally, to actually run the highlighter, you need to include this JS on your page -->
<script type="text/javascript">
    SyntaxHighlighter.all()
</script>
</body>
</html>
